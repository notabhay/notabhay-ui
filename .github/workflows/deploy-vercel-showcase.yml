name: Deploy Showcase to Vercel

on:
  release:
    types:
      - published
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'release' && startsWith(github.event.release.tag_name, 'v'))
    runs-on: ubuntu-latest
    env:
      APP_DIR: apps/showcase
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_SHOWCASE }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          missing=0
          for key in VERCEL_ORG_ID VERCEL_PROJECT_ID VERCEL_TOKEN; do
            if [ -z "${!key}" ]; then
              echo "::error::Missing required secret: $key"
              missing=1
            fi
          done

          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel project settings
        working-directory: ${{ env.APP_DIR }}
        run: vercel pull --yes --environment=production --token="${VERCEL_TOKEN}"

      - name: Build prebuilt artifacts
        working-directory: ${{ env.APP_DIR }}
        run: vercel build --prod --token="${VERCEL_TOKEN}"

      - name: Deploy prebuilt artifacts
        id: deploy
        working-directory: ${{ env.APP_DIR }}
        run: |
          deployment_url="$(vercel deploy --prebuilt --prod --token="${VERCEL_TOKEN}")"
          echo "deployment_url=${deployment_url}" >> "$GITHUB_OUTPUT"

      - name: Deployment summary
        run: |
          echo "### Vercel Production Deployment" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "- Release: \`${{ github.event.release.tag_name }}\`" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- Release: manual dispatch" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "- App: \`${APP_DIR}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- URL: ${{ steps.deploy.outputs.deployment_url }}" >> "$GITHUB_STEP_SUMMARY"
